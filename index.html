<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGENTDB - Systemzugriff</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap');

        body { background-color: #050505; color: #f4f4f4; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .fade-out { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        .evidence-preview:hover {
            outline: 3px solid #3b82f6;
            transform: scale(1.02);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        #lightbox, #changelog-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(12px);
        }

        #lightbox { background: rgba(0,0,0,0.95); }
        #changelog-overlay { background: rgba(0,0,0,0.8); }

        .changelog-frame {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }

        .agent-card {
            background: radial-gradient(circle at center, #1a1a1a 0%, #0a0a0a 100%);
            border-radius: 12px;
            border: 1px solid #333;
            background-image: radial-gradient(#222 1px, transparent 1px);
            background-size: 15px 15px;
        }
        .hidden { display: none; }
        .terminal-text { font-family: 'Fira Code', monospace; }
    </style>
</head>
<body class="min-h-screen">

    <div id="lightbox" onclick="this.style.display='none'">
        <button class="absolute top-6 right-6 text-white text-5xl hover:text-blue-500 transition">&times;</button>
        <img id="lightbox-img" src="" class="max-w-[90%] max-h-[90%] object-contain shadow-2xl">
    </div>

    <div id="changelog-overlay" class="p-4">
        <div class="changelog-frame w-full max-w-xl rounded-lg overflow-hidden border border-green-900/30">
            <div class="bg-black border-b border-zinc-800 p-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-green-500/10 p-2 rounded border border-green-500/20">
                         <i class="fas fa-terminal text-green-500 text-sm"></i>
                    </div>
                    <h2 class="text-green-500 font-black italic tracking-tighter text-lg uppercase">SYSTEM CHANGELOG</h2>
                </div>
                <button onclick="closeChangelog()" class="text-zinc-500 hover:text-white transition w-8 h-8 flex items-center justify-center rounded-full hover:bg-zinc-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="border border-green-500/20 bg-green-500/5 p-4 rounded-lg">
                    <span class="text-green-500 font-mono text-xs font-bold block mb-1">v1.0.0</span>
                    <h3 class="text-yellow-500 font-black italic uppercase text-xl mb-3">SYSTEM ERÖFFNET</h3>
                    <p class="text-zinc-400 text-sm leading-relaxed terminal-text">
                        Dieses System "AgentDB" wurde nun eröffnet und kann genutzt werden. 
                        Dieses System dient nicht zum Doxxing sondern dafür das man sich sachen hier speichert 
                        und andere sehen können was die Person macht.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="auth-screen" class="flex items-center justify-center min-h-screen p-4 fade-in">
        <div class="w-full max-w-md bg-zinc-900 border border-zinc-800 p-8 rounded-xl shadow-2xl">
            <h2 id="auth-title" class="text-2xl font-extrabold text-center mb-1 uppercase italic">System Zugriff</h2>
            <p class="text-[10px] text-zinc-500 text-center mb-10 tracking-[0.2em] uppercase">Authentifizierung erforderlich</p>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-semibold text-zinc-400 mb-2 uppercase italic text-white">Benutzername</label>
                    <div class="flex items-center bg-black border border-zinc-700 rounded-lg p-3">
                        <i class="fas fa-user text-purple-500 mr-3"></i>
                        <input type="text" id="auth-user" placeholder="Agent Name..." class="bg-transparent border-none outline-none w-full text-sm text-white">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-zinc-400 mb-2 uppercase italic text-white">Passwort</label>
                    <div class="flex items-center bg-black border border-zinc-700 rounded-lg p-3">
                        <i class="fas fa-key text-blue-500 mr-3"></i>
                        <input type="password" id="auth-pass" class="bg-transparent border-none outline-none w-full text-sm text-white">
                    </div>
                </div>
                <button id="auth-btn" onclick="handleAuthAction()" class="w-full bg-zinc-100 hover:bg-white text-black py-4 rounded-lg text-xs font-black tracking-widest uppercase transition">Account Erstellen</button>
                <p id="auth-toggle-text" class="text-center text-xs text-zinc-500">
                    Schon registriert? <a href="#" onclick="setAuthMode('login')" class="text-blue-400 font-bold">Hier einloggen.</a>
                </p>
            </div>
        </div>
    </div>

    <div id="main-interface" class="hidden">
        <nav class="bg-black/80 border-b border-zinc-800 p-4 sticky top-0 z-50 backdrop-blur-md">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-8">
                    <span class="font-black text-2xl italic tracking-tighter">AGENT<span class="text-blue-600">DB</span></span>
                    <div class="flex space-x-4">
                        <button onclick="showView('dashboard')" class="text-xs font-bold uppercase hover:text-blue-500 transition"><i class="fas fa-columns mr-1"></i> Dashboard</button>
                        <button onclick="showView('create-akte')" class="text-xs font-bold text-blue-400 hover:text-white transition uppercase"><i class="fas fa-plus-circle mr-1"></i> Akte Erstellen</button>
                    </div>
                </div>
                
                <div class="flex items-center space-x-6">
                    <button onclick="openChangelog()" class="text-[11px] font-black text-green-500 hover:text-green-400 transition bg-green-500/10 px-3 py-1.5 rounded-full border border-green-500/20">
                        v1.0.0
                    </button>
                    <div class="relative">
                        <button onclick="document.getElementById('profile-menu').classList.toggle('hidden')" class="flex items-center space-x-3 bg-zinc-900 border border-zinc-800 p-1.5 pr-4 rounded-full">
                            <img id="nav-avatar" src="" class="w-8 h-8 rounded-full object-cover">
                            <span id="nav-username" class="text-xs font-bold uppercase tracking-widest text-white">AGENT</span>
                        </button>
                        <div id="profile-menu" class="hidden absolute right-0 mt-3 w-56 bg-zinc-900 border border-zinc-800 rounded-xl shadow-2xl overflow-hidden z-50">
                            <button onclick="showView('settings')" class="w-full text-left p-4 text-xs font-bold hover:bg-zinc-800 flex items-center text-white"><i class="fas fa-cog mr-3"></i> Einstellungen</button>
                            <button onclick="showDienstausweis()" class="w-full text-left p-4 text-xs font-bold hover:bg-zinc-800 flex items-center text-white"><i class="fas fa-id-card mr-3"></i> Dienstausweis</button>
                            <button onclick="logout()" class="w-full text-left p-4 text-xs font-bold hover:bg-red-500/10 text-red-500 flex items-center border-t border-zinc-800"><i class="fas fa-sign-out-alt mr-3"></i> Abmelden</button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <main class="p-6 max-w-7xl mx-auto">
            <h2 id="welcome-msg" class="text-3xl font-black mb-8 italic uppercase text-white">WILLKOMMEN</h2>

            <div id="view-dashboard" class="view fade-in">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                    <div class="flex items-center bg-zinc-900 border border-zinc-800 p-3 rounded-xl w-full max-w-md">
                        <i class="fas fa-search text-zinc-500 mr-3 ml-2"></i>
                        <input type="text" id="search-input" placeholder="Name eingeben..." class="bg-transparent border-none outline-none w-full text-sm text-white">
                        <button onclick="renderDashboard()" class="bg-blue-600 px-4 py-1.5 rounded-lg text-[10px] font-bold uppercase hover:bg-blue-500 transition ml-2">Suchen</button>
                    </div>
                    <div class="relative">
                        <select id="prio-filter" onchange="renderDashboard()" class="bg-zinc-900 border border-zinc-800 text-white text-[10px] font-black uppercase px-4 py-3 rounded-xl outline-none cursor-pointer hover:border-zinc-600 transition appearance-none min-w-[140px]">
                            <option value="All">Priorität: Alle</option>
                            <option value="Leicht">Priorität: Leicht</option>
                            <option value="Schwer">Priorität: Schwer</option>
                            <option value="Kritisch">Priorität: Kritisch</option>
                        </select>
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-zinc-500 text-[10px]">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                </div>

                <div id="fav-section" class="mb-10 hidden">
                    <h3 class="text-yellow-500 text-[10px] font-black mb-4 uppercase tracking-widest"><i class="fas fa-star mr-2"></i> Markierte Akten</h3>
                    <div id="fav-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
                <h3 class="text-blue-500 text-[10px] font-black mb-4 uppercase tracking-widest"><i class="fas fa-folder-open mr-2"></i> Datenbank Einträge</h3>
                <div id="akte-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="view-create-akte" class="view hidden max-w-2xl mx-auto bg-zinc-900 p-8 rounded-2xl border border-zinc-800 fade-in">
                <h3 id="form-title" class="text-xl font-black mb-6 italic uppercase text-white">Akte Registrieren</h3>
                <div class="space-y-4">
                    <input type="text" id="akte-title" placeholder="Titel der Akte" class="w-full bg-black border border-zinc-800 p-4 rounded-xl text-sm outline-none focus:border-blue-500 text-white">
                    <textarea id="akte-stammdaten" placeholder="Stammdaten / Sachverhalt..." rows="5" class="w-full bg-black border border-zinc-800 p-4 rounded-xl text-sm outline-none focus:border-blue-500 text-white"></textarea>
                    <label class="block text-[10px] font-bold text-zinc-500 uppercase italic mb-[-10px]">Prioritätsstufe</label>
                    <select id="akte-prio" class="w-full bg-black border border-zinc-800 p-4 rounded-xl text-sm uppercase outline-none focus:border-blue-500 text-white">
                        <option value="Leicht">Leicht</option>
                        <option value="Schwer">Schwer</option>
                        <option value="Kritisch">Kritisch</option>
                    </select>
                    <button onclick="saveAkte()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-black text-xs uppercase tracking-widest transition">Akte Sichern</button>
                </div>
            </div>

            <div id="view-details" class="view hidden fade-in"><div id="details-content"></div></div>

            <div id="view-settings" class="view hidden max-w-xl mx-auto bg-zinc-900 p-8 rounded-2xl border border-zinc-800 fade-in">
                <h3 class="font-black mb-6 uppercase italic text-white"><i class="fas fa-user-cog mr-2"></i> Profil</h3>
                <div class="space-y-4">
                    <input type="file" id="set-avatar-file" accept="image/*" class="w-full bg-black border border-zinc-800 p-3 rounded text-xs text-white">
                    <input type="color" id="set-card-color" class="w-full h-10 bg-black border border-zinc-800 rounded">
                    <button onclick="saveSettings()" class="w-full bg-white text-black py-3 rounded-xl font-black text-xs uppercase hover:bg-zinc-200 transition">Sichern</button>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-id" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-[100] p-4 fade-in">
        <div class="agent-card w-full max-w-md p-8 border-r-8 relative shadow-2xl" id="card-border-render">
            <p class="text-[9px] text-zinc-400 font-black tracking-widest mb-1">AGENTDB IDENTITY</p>
            <h2 id="card-name" class="text-4xl font-black uppercase mb-6 italic tracking-tighter text-white">NAME</h2>
            <div class="space-y-2 text-xs text-zinc-300">
                <p><span class="text-zinc-500 font-bold uppercase mr-2">ID:</span> <span id="card-id" class="font-mono text-blue-400">PDB-0000</span></p>
                <p><span class="text-zinc-500 font-bold uppercase mr-2">Joined:</span> <span id="card-joined">01/2026</span></p>
            </div>
            <div class="mt-12 flex justify-between items-end">
                <p class="text-xs font-bold text-zinc-500 flex items-center uppercase"><i class="fas fa-shield-alt mr-2"></i> Official ID</p>
                <div class="w-24 h-32 bg-zinc-800 border-2 rounded overflow-hidden" id="card-avatar-border">
                    <img id="card-avatar" src="" class="w-full h-full object-cover">
                </div>
            </div>
            <button onclick="document.getElementById('modal-id').classList.add('hidden')" class="absolute top-4 right-4 text-zinc-600 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
        </div>
    </div>

    <script>
        let currentUser = JSON.parse(localStorage.getItem('logged_in_user')) || null;
        let akten = JSON.parse(localStorage.getItem('akten')) || [];
        let authMode = 'register';
        let activeAkteId = null;

        window.onload = () => { if(currentUser) loginSuccess(); };

        function openChangelog() {
            const el = document.getElementById('changelog-overlay');
            el.style.display = 'flex';
            el.classList.remove('fade-out');
            el.classList.add('fade-in');
        }

        function closeChangelog() {
            const el = document.getElementById('changelog-overlay');
            el.classList.add('fade-out');
            setTimeout(() => { el.style.display = 'none'; }, 300);
        }

        function renderDashboard() {
            const list = document.getElementById('akte-list');
            const favList = document.getElementById('fav-list');
            const search = document.getElementById('search-input').value.toLowerCase();
            const filter = document.getElementById('prio-filter').value;
            
            list.innerHTML = ""; favList.innerHTML = "";
            let foundCount = 0;

            akten.forEach(a => {
                const matchesSearch = a.title.toLowerCase().includes(search);
                const matchesFilter = filter === 'All' || a.prio === filter;

                if(matchesSearch && matchesFilter) {
                    foundCount++;
                    const isFav = currentUser.favorites && currentUser.favorites.includes(a.id);
                    const card = `
                    <div class="bg-zinc-900 border border-zinc-800 p-6 rounded-2xl relative hover:border-blue-500/50 transition fade-in">
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-[9px] font-black px-2 py-1 bg-black rounded border border-zinc-800 uppercase italic text-zinc-500">PUBLIC</span>
                            <span class="text-[10px] font-black uppercase ${a.prio === 'Kritisch' ? 'text-red-500' : (a.prio === 'Schwer' ? 'text-yellow-500' : 'text-green-500')}"><i class="fas fa-exclamation-triangle mr-1"></i> ${a.prio}</span>
                        </div>
                        <h4 class="font-black text-xl mb-2 italic uppercase tracking-tighter text-white">${a.title}</h4>
                        <p class="text-xs text-zinc-500 mb-6 line-clamp-2">${a.stammdaten}</p>
                        <button onclick="openAkte(${a.id})" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl text-[10px] font-black tracking-widest transition uppercase">Akte Öffnen</button>
                    </div>`;
                    if(isFav) favList.innerHTML += card;
                    list.innerHTML += card;
                }
            });

            if(foundCount === 0) {
                list.innerHTML = `<div class="col-span-full py-20 text-center fade-in text-zinc-600 uppercase font-black text-xs tracking-widest">Keine passenden Einträge gefunden.</div>`;
            }
            document.getElementById('fav-section').classList.toggle('hidden', !currentUser.favorites || currentUser.favorites.length === 0);
        }

        // Rest of the login, save, and detail functions
        function setAuthMode(mode) {
            authMode = mode;
            document.getElementById('auth-title').innerText = mode === 'register' ? "Account Erstellen" : "Einloggen";
            document.getElementById('auth-btn').innerText = mode === 'register' ? "Account Erstellen" : "Einloggen";
        }

        function handleAuthAction() {
            const user = document.getElementById('auth-user').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            if(!user || !pass) return alert("Eingaben fehlen!");
            if(authMode === 'register') {
                if(localStorage.getItem(`user_${user}`)) return alert("Name vergeben!");
                const newUser = {
                    name: user, pass: pass,
                    id: 'PDB-' + Math.floor(1000 + Math.random() * 8999),
                    joined: new Date().toLocaleDateString('de-DE', { month: '2-digit', year: 'numeric' }),
                    avatar: 'https://i.imgur.com/8m5XNlE.png',
                    cardColor: '#3b82f6', favorites: []
                };
                localStorage.setItem(`user_${user}`, JSON.stringify(newUser));
                currentUser = newUser; loginSuccess();
            } else {
                const stored = JSON.parse(localStorage.getItem(`user_${user}`));
                if(stored && stored.pass === pass) { currentUser = stored; loginSuccess(); }
                else alert("Zugriff verweigert!");
            }
        }

        function loginSuccess() {
            localStorage.setItem('logged_in_user', JSON.stringify(currentUser));
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-interface').classList.remove('hidden');
            document.getElementById('nav-username').innerText = currentUser.name;
            document.getElementById('nav-avatar').src = currentUser.avatar;
            document.getElementById('welcome-msg').innerHTML = `<i class="fas fa-terminal mr-3 text-blue-500"></i>Willkommen, Agent ${currentUser.name}`;
            renderDashboard();
        }

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            document.getElementById('profile-menu').classList.add('hidden');
            if(viewId === 'dashboard') renderDashboard();
            if(viewId === 'create-akte' && !activeAkteId) resetForm();
        }

        function resetForm() {
            activeAkteId = null;
            document.getElementById('form-title').innerText = "Akte Registrieren";
            document.getElementById('akte-title').value = "";
            document.getElementById('akte-stammdaten').value = "";
            document.getElementById('akte-prio').value = "Leicht";
        }

        function saveAkte() {
            const title = document.getElementById('akte-title').value;
            if(!title) return alert("Titel fehlt!");
            if(activeAkteId) {
                const index = akten.findIndex(a => a.id === activeAkteId);
                if(index !== -1) {
                    akten[index].title = title;
                    akten[index].stammdaten = document.getElementById('akte-stammdaten').value;
                    akten[index].prio = document.getElementById('akte-prio').value;
                }
            } else {
                akten.push({
                    id: Date.now(), title: title,
                    stammdaten: document.getElementById('akte-stammdaten').value,
                    prio: document.getElementById('akte-prio').value,
                    creator: currentUser.name, createdDate: new Date().toLocaleDateString(),
                    entries: []
                });
            }
            localStorage.setItem('akten', JSON.stringify(akten));
            activeAkteId = null; showView('dashboard');
        }

        function openAkte(id) {
            const akte = akten.find(a => a.id === id);
            if(!akte) return;
            activeAkteId = id; showView('details');
            const isAdmin = currentUser.name === "Zynox";
            const isCreator = akte.creator === currentUser.name;
            const isFav = currentUser.favorites && currentUser.favorites.includes(id);

            document.getElementById('details-content').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-zinc-900 border border-zinc-800 p-8 rounded-2xl">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-3xl font-black uppercase italic tracking-tighter text-white">${akte.title}</h2>
                                <span class="text-xs font-bold text-zinc-500"><i class="fas fa-calendar-alt mr-2"></i>${akte.createdDate}</span>
                            </div>
                            <p class="text-[10px] font-bold text-zinc-500 mb-2 uppercase italic">Sachverhalt</p>
                            <div class="bg-black/60 p-6 rounded-xl border border-zinc-800 text-sm text-zinc-300">${akte.stammdaten}</div>
                        </div>
                        <div class="bg-zinc-900 border border-zinc-800 p-8 rounded-2xl">
                            <h3 class="text-xs font-black mb-6 uppercase italic text-white"><i class="fas fa-plus-square mr-2 text-blue-500"></i> Neuen Eintrag Hinzufügen</h3>
                            <textarea id="entry-text" class="w-full bg-black border border-zinc-800 p-4 rounded-xl text-sm mb-4 outline-none focus:border-blue-500 text-white" placeholder="Ereignis eingeben..."></textarea>
                            <div class="flex items-center justify-between">
                                <input type="file" id="entry-file" class="text-[10px] text-zinc-500">
                                <button onclick="addEntry(${id})" class="bg-blue-600 text-white px-6 py-3 rounded-xl text-[10px] font-black uppercase">Eintrag Sichern</button>
                            </div>
                        </div>
                        <div class="space-y-4">
                            ${akte.entries.map((e, i) => `
                                <div class="bg-zinc-900 border border-zinc-800 p-6 rounded-2xl fade-in">
                                    <div class="flex justify-between mb-2">
                                        <p class="text-[10px] font-black text-blue-400 uppercase"><i class="fas fa-user-secret mr-1"></i> ${e.author}</p>
                                        ${(isAdmin || isCreator || e.author === currentUser.name) ? `<button onclick="deleteEntry(${id}, ${i})" class="text-red-500 hover:text-red-400 transition"><i class="fas fa-trash"></i></button>` : ''}
                                    </div>
                                    <p class="text-sm text-zinc-300 mb-4">${e.text}</p>
                                    ${e.file ? `
                                        <div class="mt-6">
                                            <div class="flex items-center justify-between mb-3">
                                                <div class="flex items-center">
                                                    <div class="w-[3px] h-4 bg-blue-600 mr-2 rounded-full"></div>
                                                    <p class="text-[10px] font-black text-blue-600 uppercase tracking-widest italic">Beweismittel:</p>
                                                </div>
                                                <button onclick="downloadImage('${e.file}', 'BEWEIS_${akte.title.replace(/\s+/g, '_')}_${i}')" class="text-[9px] font-bold border border-zinc-700 px-2 py-1 rounded hover:bg-white hover:text-black transition">
                                                    <i class="fas fa-download mr-1"></i> DOWNLOAD
                                                </button>
                                            </div>
                                            <img src="${e.file}" onclick="zoomImg('${e.file}')" class="max-w-xs rounded-lg border border-zinc-800 evidence-preview shadow-xl">
                                        </div>` : ''}
                                </div>`).join('')}
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-zinc-900 border border-zinc-800 p-6 rounded-2xl">
                            <p class="text-xs mb-4 uppercase text-zinc-400"><span class="text-zinc-500 font-bold">Ersteller:</span> ${akte.creator}</p>
                            <div class="space-y-3">
                                ${isCreator ? `<button onclick="editAkte(${id})" class="w-full p-4 rounded-xl text-xs font-black border border-purple-500/20 text-purple-500 hover:bg-purple-500 hover:text-white transition uppercase"><i class="fas fa-edit mr-2"></i>Bearbeiten</button>` : ''}
                                <button onclick="toggleFav(${id})" class="w-full p-4 rounded-xl text-xs font-black border border-yellow-500/20 text-yellow-500 ${isFav ? 'bg-yellow-500 text-black' : ''} transition uppercase"><i class="fas fa-star mr-2"></i>${isFav ? 'Gemerkt' : 'Favorisieren'}</button>
                                ${(isAdmin || isCreator) ? `<button onclick="deleteAkte(${id})" class="w-full p-4 rounded-xl text-xs font-black border border-red-500/20 text-red-500 hover:bg-red-500 hover:text-white transition uppercase"><i class="fas fa-trash-alt mr-2"></i>Löschen</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function downloadImage(dataUrl, name) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = name + '.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function addEntry(id) {
            const text = document.getElementById('entry-text').value;
            const file = document.getElementById('entry-file').files[0];
            if(!text && !file) return;
            const akte = akten.find(a => a.id === id);
            const save = (data) => {
                akte.entries.unshift({ author: currentUser.name, text, file: data });
                localStorage.setItem('akten', JSON.stringify(akten)); openAkte(id);
            };
            if(file) { const r = new FileReader(); r.onload = (e) => save(e.target.result); r.readAsDataURL(file); }
            else save(null);
        }

        function toggleFav(id) {
            const idx = currentUser.favorites.indexOf(id);
            if(idx > -1) currentUser.favorites.splice(idx, 1); else currentUser.favorites.push(id);
            localStorage.setItem(`user_${currentUser.name}`, JSON.stringify(currentUser));
            localStorage.setItem('logged_in_user', JSON.stringify(currentUser));
            openAkte(id);
        }

        function editAkte(id) {
            const a = akten.find(x => x.id === id);
            activeAkteId = id; showView('create-akte');
            document.getElementById('form-title').innerText = "AKTE BEARBEITEN";
            document.getElementById('akte-title').value = a.title;
            document.getElementById('akte-stammdaten').value = a.stammdaten;
            document.getElementById('akte-prio').value = a.prio;
        }

        function deleteAkte(id) { if(confirm("Akte vernichten?")) { akten = akten.filter(a => a.id !== id); localStorage.setItem('akten', JSON.stringify(akten)); showView('dashboard'); } }
        function deleteEntry(aid, i) { if(confirm("Eintrag entfernen?")) { akten.find(a => a.id === aid).entries.splice(i, 1); localStorage.setItem('akten', JSON.stringify(akten)); openAkte(aid); } }
        function logout() { localStorage.removeItem('logged_in_user'); location.reload(); }
        function zoomImg(src) { document.getElementById('lightbox-img').src = src; document.getElementById('lightbox').style.display = 'flex'; }

        function showDienstausweis() {
            document.getElementById('modal-id').classList.remove('hidden');
            document.getElementById('card-name').innerText = currentUser.name;
            document.getElementById('card-id').innerText = currentUser.id;
            document.getElementById('card-joined').innerText = currentUser.joined;
            document.getElementById('card-avatar').src = currentUser.avatar;
            document.getElementById('card-border-render').style.borderColor = currentUser.cardColor;
        }

        function saveSettings() {
            const file = document.getElementById('set-avatar-file').files[0];
            const color = document.getElementById('set-card-color').value;
            const update = (img) => {
                currentUser.avatar = img || currentUser.avatar;
                currentUser.cardColor = color;
                localStorage.setItem(`user_${currentUser.name}`, JSON.stringify(currentUser));
                localStorage.setItem('logged_in_user', JSON.stringify(currentUser));
                loginSuccess();
            };
            if(file) { const r = new FileReader(); r.onload = (e) => update(e.target.result); r.readAsDataURL(file); }
            else update(null);
        }
    </script>
</body>
</html>
