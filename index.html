<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGENTDB - Full System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap');
        body { background-color: #000; color: #fff; font-family: 'Inter', sans-serif; margin: 0; overflow-x: hidden; }
        
        /* Altes Login Design */
        .login-container { background: #0a0a0a; border: 1px solid #1a1a1a; padding: 40px; width: 100%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .input-old { background: #000; border: 1px solid #222; color: #fff; padding: 12px; width: 100%; outline: none; margin-bottom: 15px; font-size: 13px; }
        .btn-old { background: #fff; color: #000; font-weight: 900; text-transform: uppercase; padding: 12px; width: 100%; font-size: 11px; transition: 0.2s; }
        .btn-old:hover { background: #3b82f6; color: #fff; }

        /* Navbar Icons & Text */
        .nav-link { font-size: 11px; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: 0.2s; }
        .nav-link:hover { color: #3b82f6; }

        /* Akten Karten */
        .akte-card { background: #050505; border: 1px solid #1a1a1a; padding: 25px; position: relative; }
        .badge { font-size: 9px; font-weight: 900; color: #3b82f6; text-transform: uppercase; margin-bottom: 5px; display: block; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="auth-screen" class="flex items-center justify-center min-h-screen p-4">
        <div class="login-container">
            <h2 class="text-2xl font-black italic uppercase mb-8 tracking-tighter text-center">Systemzugriff</h2>
            <input type="text" id="username" placeholder="AGENT NAME" class="input-old">
            <input type="password" id="password" placeholder="PASSWORT" class="input-old">
            <button onclick="login()" class="btn-old">Initialisieren</button>
        </div>
    </div>

    <div id="main-ui" class="hidden">
        <nav class="flex justify-between items-center px-8 py-6 bg-black border-b border-zinc-900 sticky top-0 z-50">
            <div class="text-xl font-black italic tracking-tighter uppercase">
                AGENT<span class="text-blue-600">DB</span>
            </div>
            <div class="flex gap-8 items-center">
                <span onclick="showPage('dashboard')" class="nav-link">Dashboard</span>
                <span onclick="showPage('create')" class="nav-link">Neue Akte</span>
                <button onclick="location.reload()" class="text-red-600 hover:text-red-400">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </nav>

        <main class="p-8 max-w-7xl mx-auto">
            
            <div id="page-dashboard" class="page">
                <div id="akte-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    </div>
            </div>

            <div id="page-create" class="page hidden">
                <div class="max-w-2xl bg-zinc-900/30 p-8 border border-zinc-800">
                    <h2 class="font-black italic uppercase mb-6 text-blue-500">Neue Akte registrieren</h2>
                    <input type="text" id="new-title" placeholder="NAME / TITEL DER AKTE" class="input-old">
                    <textarea id="new-content" rows="8" placeholder="VOLLSTÄNDIGER SACHVERHALT..." class="input-old"></textarea>
                    <button onclick="saveAkte()" class="btn-old bg-blue-600 text-white border-none">Akte in Datenbank schreiben</button>
                </div>
            </div>

            <div id="page-details" class="page hidden">
                <button onclick="showPage('dashboard')" class="text-[10px] font-bold uppercase mb-6 text-zinc-500 hover:text-white">← Zurück zur Übersicht</button>
                <div id="details-content"></div>
            </div>

        </main>
    </div>

    <script>
        // FIREBASE SETUP
        const firebaseConfig = {
            apiKey: "AIzaSyDOb5MW38F-Fa7izcp9mwirWf7Slv88WR8",
            authDomain: "agentdb-1d51c.firebaseapp.com",
            projectId: "agentdb-1d51c",
            storageBucket: "agentdb-1d51c.firebasestorage.app",
            messagingSenderId: "883419188103",
            appId: "1:883419188103:web:045744479f338ec51ea122"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let loggedInUser = "";
        let currentAkten = [];

        // LOGIN FUNKTION
        function login() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            if(user && pass) {
                loggedInUser = user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-ui').classList.remove('hidden');
                loadData();
            }
        }

        // SEITEN STEUERUNG
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById('page-' + pageId).classList.remove('hidden');
        }

        // DATEN AUS CLOUD LADEN
        function loadData() {
            db.collection("global_akten").orderBy("createdAt", "desc").onSnapshot(snap => {
                currentAkten = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboard();
            });
        }

        function renderDashboard() {
            const container = document.getElementById('akte-container');
            container.innerHTML = "";
            currentAkten.forEach(akte => {
                container.innerHTML += `
                    <div class="akte-card">
                        <span class="badge">Eintrag #${akte.id.substring(0,6)}</span>
                        <h3 class="text-lg font-black uppercase italic mb-3">${akte.title}</h3>
                        <p class="text-zinc-500 text-xs mb-6 line-clamp-3">${akte.stammdaten || ''}</p>
                        <button onclick="viewAkte('${akte.id}')" class="text-[10px] font-black border border-zinc-800 px-4 py-2 hover:bg-white hover:text-black w-full transition">Öffnen</button>
                    </div>
                `;
            });
        }

        // AKTE DETAIL ANSICHT & KOMMENTARE
        function viewAkte(id) {
            const akte = currentAkten.find(a => a.id === id);
            showPage('details');
            const detailsDiv = document.getElementById('details-content');
            detailsDiv.innerHTML = `
                <div class="bg-zinc-900/50 p-8 border border-zinc-800 mb-8">
                    <h1 class="text-3xl font-black uppercase italic mb-4">${akte.title}</h1>
                    <p class="text-zinc-400 leading-relaxed">${akte.stammdaten}</p>
                </div>
                
                <div class="space-y-4 mb-8">
                    <h4 class="text-xs font-black uppercase text-blue-500 italic">Einsatzberichte / Kommentare</h4>
                    <div id="comments-list" class="space-y-2">
                        ${(akte.entries || []).map(e => `
                            <div class="bg-black border border-zinc-900 p-4">
                                <div class="flex justify-between text-[10px] font-bold uppercase mb-1">
                                    <span class="text-blue-400">${e.author}</span>
                                    <span class="text-zinc-600">${e.date}</span>
                                </div>
                                <p class="text-sm">${e.text}</p>
                            </div>
                        `).reverse().join('')}
                    </div>
                </div>

                <div class="bg-black border border-zinc-800 p-6">
                    <textarea id="comment-text" placeholder="BERICHT SCHREIBEN..." class="input-old mb-2"></textarea>
                    <button onclick="addComment('${id}')" class="btn-old bg-white text-black">Bericht absenden</button>
                </div>
            `;
        }

        async function addComment(id) {
            const text = document.getElementById('comment-text').value;
            if(!text) return;
            
            const newEntry = {
                author: loggedInUser,
                text: text,
                date: new Date().toLocaleString('de-DE')
            };

            await db.collection("global_akten").doc(id).update({
                entries: firebase.firestore.FieldValue.arrayUnion(newEntry)
            });
            
            viewAkte(id); // Ansicht aktualisieren
        }

        async function saveAkte() {
            const t = document.getElementById('new-title').value;
            const c = document.getElementById('new-content').value;
            if(!t) return;

            await db.collection("global_akten").add({
                title: t,
                stammdaten: c,
                author: loggedInUser,
                createdAt: new Date(),
                entries: []
            });

            document.getElementById('new-title').value = "";
            document.getElementById('new-content').value = "";
            showPage('dashboard');
        }
    </script>
</body>
</html>
