<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGENTDB - Systemzugriff</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap');

        body { background-color: #050505; color: #f4f4f4; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .agent-card { background: radial-gradient(circle at center, #1a1a1a 0%, #0a0a0a 100%); border-radius: 12px; border: 1px solid #333; }
        .hidden { display: none; }
        .terminal-text { font-family: 'Fira Code', monospace; }
        .admin-glow { box-shadow: 0 0 15px rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.4); }
    </style>
</head>
<body class="min-h-screen">

    <div id="auth-screen" class="flex items-center justify-center min-h-screen p-4 fade-in">
        <div class="w-full max-w-md bg-zinc-900 border border-zinc-800 p-8 rounded-xl shadow-2xl text-center">
            <h2 id="auth-title" class="text-2xl font-extrabold mb-1 uppercase italic text-white">Account Erstellen</h2>
            <p class="text-[10px] text-zinc-500 mb-10 tracking-[0.2em] uppercase">Sicherheitsprüfung aktiv</p>
            <div class="space-y-5 text-left">
                <input type="text" id="auth-user" placeholder="Agent Name..." class="w-full bg-black border border-zinc-700 rounded-lg p-3 text-sm text-white outline-none">
                <input type="password" id="auth-pass" placeholder="Passwort" class="w-full bg-black border border-zinc-700 rounded-lg p-3 text-sm text-white outline-none">
                <button id="auth-btn" onclick="handleAuthAction()" class="w-full bg-white text-black py-4 rounded-lg text-xs font-black tracking-widest uppercase hover:bg-zinc-200 transition">Bestätigen</button>
                <p id="auth-toggle-text" class="text-center text-xs text-zinc-500">
                    Schon registriert? <a href="#" onclick="setAuthMode('login')" class="text-blue-400 font-bold">Einloggen</a>
                </p>
            </div>
        </div>
    </div>

    <div id="main-interface" class="hidden">
        <nav class="bg-black/80 border-b border-zinc-800 p-4 sticky top-0 z-50 backdrop-blur-md">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-8">
                    <span class="font-black text-2xl italic tracking-tighter">AGENT<span class="text-blue-600">DB</span></span>
                    <div class="flex space-x-6 items-center">
                        <button onclick="showView('dashboard')" class="text-xs font-bold uppercase text-white hover:text-blue-500 transition">Dashboard</button>
                        <button onclick="showView('create-akte')" class="text-xs font-bold text-blue-400 uppercase hover:text-white transition">Akte Erstellen</button>
                        <button id="admin-nav-btn" onclick="showView('admin')" class="hidden text-xs font-bold text-red-500 uppercase flex items-center bg-red-500/10 px-3 py-2 rounded-lg border border-red-500/20 hover:bg-red-500/20 transition">
                            <i class="fas fa-gavel mr-2"></i> Administrator
                        </button>
                    </div>
                </div>
                <button onclick="logout()" class="text-zinc-500 hover:text-red-500 transition"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </nav>

        <main class="p-6 max-w-7xl mx-auto">
            <div id="view-dashboard" class="view fade-in">
                <h2 class="text-2xl font-black mb-8 italic uppercase text-white">Datenbank-Übersicht</h2>
                <div id="akte-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="view-create-akte" class="view hidden max-w-2xl mx-auto bg-zinc-900 p-8 rounded-2xl border border-zinc-800 fade-in">
                <h3 class="text-xl font-black mb-6 uppercase text-white italic">Akte Registrieren</h3>
                <input type="text" id="akte-title" placeholder="Titel der Akte" class="w-full bg-black border border-zinc-800 p-4 rounded-xl text-sm mb-4 text-white outline-none focus:border-blue-500">
                <textarea id="akte-stammdaten" placeholder="Sachverhalt..." rows="5" class="w-full bg-black border border-zinc-800 p-4 rounded-xl text-sm mb-4 text-white outline-none focus:border-blue-500"></textarea>
                <select id="akte-prio" class="w-full bg-black border border-zinc-800 p-4 rounded-xl text-sm mb-4 text-white outline-none">
                    <option value="Leicht">Priorität: Leicht</option>
                    <option value="Schwer">Priorität: Schwer</option>
                    <option value="Kritisch">Priorität: Kritisch</option>
                </select>
                <button onclick="saveAkte()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-black text-xs uppercase tracking-widest transition">In Cloud Sichern</button>
            </div>

            <div id="view-admin" class="view hidden space-y-8 fade-in">
                <div class="bg-red-950/20 border border-red-900/50 p-8 rounded-2xl admin-glow">
                    <h2 class="text-red-500 font-black text-2xl italic uppercase mb-6 flex items-center">
                        <i class="fas fa-shield-halved mr-3"></i> Admin Control Center
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <h3 class="text-white font-bold text-sm uppercase">Datenbank-Management</h3>
                            <button onclick="deleteAllAkten()" class="w-full bg-red-600 hover:bg-red-700 text-white p-4 rounded-xl font-black text-[10px] uppercase tracking-tighter transition shadow-lg">
                                <i class="fas fa-trash-alt mr-2"></i> Alle Akten löschen (Vorsicht!)
                            </button>
                        </div>

                        <div class="space-y-4">
                            <h3 class="text-white font-bold text-sm uppercase">Aktive Bann-Liste</h3>
                            <div id="ban-list-container" class="bg-black/50 border border-red-900/30 rounded-xl p-4 max-h-[300px] overflow-y-auto">
                                <p class="text-[10px] text-zinc-500 uppercase text-center italic">Lade Bann-Daten...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-details" class="view hidden fade-in"><div id="details-content"></div></div>
        </main>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDOb5MW38F-Fa7izcp9mwirWf7Slv88WR8",
            authDomain: "agentdb-1d51c.firebaseapp.com",
            projectId: "agentdb-1d51c",
            storageBucket: "agentdb-1d51c.firebasestorage.app",
            messagingSenderId: "883419188103",
            appId: "1:883419188103:web:045744479f338ec51ea122"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = JSON.parse(localStorage.getItem('logged_in_user')) || null;
        let globalAkten = [];
        let authMode = 'register';
        let userIP = "Unbekannt";

        // IP-Check
        fetch('https://api.ipify.org?format=json').then(r => r.json()).then(d => userIP = d.ip).catch(() => userIP = "127.0.0.1");

        window.onload = () => { if(currentUser) loginSuccess(); };

        function setAuthMode(mode) {
            authMode = mode;
            document.getElementById('auth-title').innerText = mode === 'register' ? "Account Erstellen" : "Einloggen";
        }

        async function handleAuthAction() {
            const user = document.getElementById('auth-user').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            if(!user || !pass) return alert("Eingaben fehlen!");

            const banCheck = await db.collection("banned_ips").doc(userIP).get();
            if(banCheck.exists) return alert("SYSTEM-SPERRE: Deine IP ist auf der schwarzen Liste.");

            if(authMode === 'register') {
                currentUser = { name: user, pass: pass, ip: userIP, favorites: [] };
                localStorage.setItem(`user_${user}`, JSON.stringify(currentUser));
                loginSuccess();
            } else {
                const stored = JSON.parse(localStorage.getItem(`user_${user}`));
                if(stored && stored.pass === pass) { currentUser = stored; loginSuccess(); }
                else alert("Zugriff verweigert!");
            }
        }

        function loginSuccess() {
            localStorage.setItem('logged_in_user', JSON.stringify(currentUser));
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-interface').classList.remove('hidden');
            
            if(currentUser.name === "Zynox") {
                document.getElementById('admin-nav-btn').classList.remove('hidden');
                listenToBans();
            }
            listenToCloud();
        }

        function listenToCloud() {
            db.collection("global_akten").orderBy("createdAt", "desc").onSnapshot(s => {
                globalAkten = s.docs.map(d => ({ cloudId: d.id, ...d.data() }));
                renderDashboard();
            });
        }

        function listenToBans() {
            db.collection("banned_ips").onSnapshot(s => {
                const container = document.getElementById('ban-list-container');
                if(s.empty) { container.innerHTML = '<p class="text-[10px] text-zinc-600 text-center">Keine User gebannt.</p>'; return; }
                
                container.innerHTML = s.docs.map(d => `
                    <div class="flex items-center justify-between border-b border-red-900/20 py-3">
                        <div>
                            <p class="text-xs font-bold text-red-500">${d.data().bannedUser}</p>
                            <p class="text-[9px] text-zinc-500">${d.id}</p>
                        </div>
                        <button onclick="unbanUser('${d.id}')" class="text-[10px] text-zinc-300 hover:text-white bg-red-900/40 px-2 py-1 rounded">Entbannen</button>
                    </div>
                `).join('');
            });
        }

        function renderDashboard() {
            const list = document.getElementById('akte-list');
            list.innerHTML = globalAkten.map(a => `
                <div class="bg-zinc-900 border border-zinc-800 p-6 rounded-2xl relative hover:border-blue-500/50 transition fade-in">
                    <div class="flex justify-between mb-4">
                        <span class="text-[9px] font-black px-2 py-1 bg-black rounded border border-zinc-800 uppercase italic text-zinc-500">Global Case</span>
                        <span class="text-[10px] font-black uppercase ${a.prio.includes('Kritisch') ? 'text-red-500' : 'text-blue-400'}">${a.prio}</span>
                    </div>
                    <h4 class="font-black text-xl mb-1 text-white italic uppercase tracking-tighter">${a.title}</h4>
                    <p class="text-[9px] text-zinc-600 mb-6 uppercase">Erstellt von: ${a.creator}</p>
                    <button onclick="openAkte('${a.cloudId}')" class="w-full bg-blue-600 text-white py-3 rounded-xl text-[10px] font-black uppercase hover:bg-blue-500 transition">Öffnen</button>
                    ${currentUser.name === "Zynox" ? `<button onclick="deleteAkte('${a.cloudId}')" class="mt-2 w-full text-[9px] text-red-500/50 hover:text-red-500 uppercase font-bold">Akte vernichten</button>` : ''}
                </div>
            `).join('');
        }

        function openAkte(id) {
            const akte = globalAkten.find(a => a.cloudId === id);
            showView('details');
            document.getElementById('details-content').innerHTML = `
                <div class="bg-zinc-900 p-8 rounded-2xl border border-zinc-800 fade-in">
                    <h2 class="text-3xl font-black text-white mb-6 uppercase italic">${akte.title}</h2>
                    <div class="bg-black/50 p-6 rounded-xl border border-zinc-800 text-zinc-300 text-sm mb-6">${akte.stammdaten}</div>
                    
                    ${currentUser.name === "Zynox" ? `
                        <div class="border-t border-red-900/30 pt-6 mt-6">
                            <p class="text-[10px] text-red-500 font-bold mb-3 uppercase">Sicherheits-Protokoll (Admin)</p>
                            <p class="text-xs text-zinc-500 mb-4">Agent: ${akte.creator} | IP: ${akte.creatorIP}</p>
                            <button onclick="banUser('${akte.creatorIP}', '${akte.creator}')" class="bg-red-600 text-white px-6 py-3 rounded-xl text-[10px] font-black uppercase hover:shadow-lg hover:shadow-red-600/20 transition">User permanent bannen</button>
                        </div>
                    ` : ''}
                </div>`;
        }

        // --- ADMIN FUNKTIONEN ---
        async function deleteAllAkten() {
            if(confirm("BIST DU SICHER? Alle Akten in der globalen Cloud werden gelöscht!")) {
                const batch = db.batch();
                const snapshot = await db.collection("global_akten").get();
                snapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                alert("Datenbank wurde geleert.");
                showView('dashboard');
            }
        }

        function banUser(ip, name) {
            if(!ip || ip === "Unbekannt") return alert("IP-Adresse konnte nicht ermittelt werden.");
            if(confirm(`${name} (${ip}) wirklich bannen?`)) {
                db.collection("banned_ips").doc(ip).set({ bannedUser: name, date: new Date().toISOString() })
                .then(() => { alert("IP wurde gesperrt."); showView('admin'); });
            }
        }

        function unbanUser(ip) {
            if(confirm("Sperre für IP " + ip + " aufheben?")) {
                db.collection("banned_ips").doc(ip).delete();
            }
        }

        // --- STANDARD FUNKTIONEN ---
        function saveAkte() {
            const title = document.getElementById('akte-title').value;
            const stammdaten = document.getElementById('akte-stammdaten').value;
            if(!title || !stammdaten) return alert("Fehlende Daten!");
            
            db.collection("global_akten").add({
                title, stammdaten, prio: document.getElementById('akte-prio').value,
                creator: currentUser.name, creatorIP: userIP,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => { showView('dashboard'); });
        }

        function deleteAkte(id) { if(confirm("Akte löschen?")) db.collection("global_akten").doc(id).delete(); }
        function showView(v) { document.querySelectorAll('.view').forEach(e => e.classList.add('hidden')); document.getElementById('view-'+v).classList.remove('hidden'); }
        function logout() { localStorage.removeItem('logged_in_user'); location.reload(); }
    </script>
</body>
</html>
