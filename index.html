<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGENTDB - Systemzugriff</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap');

        body { background-color: #050505; color: #f4f4f4; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .evidence-preview:hover { outline: 3px solid #3b82f6; transform: scale(1.02); transition: all 0.3s ease; cursor: pointer; }
        #lightbox, #changelog-overlay { display: none; position: fixed; inset: 0; z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(12px); }
        #lightbox { background: rgba(0,0,0,0.95); }
        #changelog-overlay { background: rgba(0,0,0,0.8); }
        .agent-card { background: radial-gradient(circle at center, #1a1a1a 0%, #0a0a0a 100%); border-radius: 12px; border: 1px solid #333; }
        .hidden { display: none; }
        .terminal-text { font-family: 'Fira Code', monospace; }
    </style>
</head>
<body class="min-h-screen">

    <div id="lightbox" onclick="this.style.display='none'">
        <img id="lightbox-img" src="" class="max-w-[90%] max-h-[90%] object-contain shadow-2xl">
    </div>

    <div id="auth-screen" class="flex items-center justify-center min-h-screen p-4 fade-in">
        <div class="w-full max-w-md bg-zinc-900 border border-zinc-800 p-8 rounded-xl shadow-2xl text-center">
            <h2 id="auth-title" class="text-2xl font-extrabold mb-1 uppercase italic text-white">Account Erstellen</h2>
            <p class="text-[10px] text-zinc-500 mb-10 tracking-[0.2em] uppercase">Sicherheitsprüfung aktiv</p>
            
            <div class="space-y-5 text-left">
                <input type="text" id="auth-user" placeholder="Agent Name..." class="w-full bg-black border border-zinc-700 rounded-lg p-3 text-sm text-white outline-none">
                <input type="password" id="auth-pass" placeholder="Passwort" class="w-full bg-black border border-zinc-700 rounded-lg p-3 text-sm text-white outline-none">
                <button id="auth-btn" onclick="handleAuthAction()" class="w-full bg-white text-black py-4 rounded-lg text-xs font-black tracking-widest uppercase hover:bg-zinc-200 transition">Bestätigen</button>
                <p id="auth-toggle-text" class="text-center text-xs text-zinc-500">
                    Schon registriert? <a href="#" onclick="setAuthMode('login')" class="text-blue-400 font-bold">Einloggen</a>
                </p>
            </div>
        </div>
    </div>

    <div id="main-interface" class="hidden">
        <nav class="bg-black/80 border-b border-zinc-800 p-4 sticky top-0 z-50 backdrop-blur-md">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <span class="font-black text-2xl italic tracking-tighter">AGENT<span class="text-blue-600">DB</span></span>
                <div class="flex space-x-6 items-center">
                    <button onclick="showView('dashboard')" class="text-xs font-bold uppercase text-white">Dashboard</button>
                    <button onclick="showView('create-akte')" class="text-xs font-bold text-blue-400 uppercase">Neue Akte</button>
                    <button onclick="logout()" class="text-red-500 text-xs font-bold uppercase"><i class="fas fa-power-off"></i></button>
                </div>
            </div>
        </nav>

        <main class="p-6 max-w-7xl mx-auto">
            <div id="view-dashboard" class="view fade-in">
                <div id="akte-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="view-create-akte" class="view hidden max-w-2xl mx-auto bg-zinc-900 p-8 rounded-2xl border border-zinc-800 fade-in">
                <h3 class="text-xl font-black mb-6 uppercase text-white">Akte Registrieren</h3>
                <input type="text" id="akte-title" placeholder="Titel" class="w-full bg-black border border-zinc-800 p-4 rounded-xl text-sm mb-4 text-white">
                <textarea id="akte-stammdaten" placeholder="Inhalt..." rows="5" class="w-full bg-black border border-zinc-800 p-4 rounded-xl text-sm mb-4 text-white"></textarea>
                <select id="akte-prio" class="w-full bg-black border border-zinc-800 p-4 rounded-xl text-sm mb-4 text-white">
                    <option value="Leicht">Leicht</option>
                    <option value="Schwer">Schwer</option>
                    <option value="Kritisch">Kritisch</option>
                </select>
                <button onclick="saveAkte()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black text-xs uppercase">Speichern</button>
            </div>

            <div id="view-details" class="view hidden fade-in"><div id="details-content"></div></div>
        </main>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDOb5MW38F-Fa7izcp9mwirWf7Slv88WR8",
            authDomain: "agentdb-1d51c.firebaseapp.com",
            projectId: "agentdb-1d51c",
            storageBucket: "agentdb-1d51c.firebasestorage.app",
            messagingSenderId: "883419188103",
            appId: "1:883419188103:web:045744479f338ec51ea122"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = JSON.parse(localStorage.getItem('logged_in_user')) || null;
        let globalAkten = [];
        let authMode = 'register';
        let userIP = "";

        // IP Adresse abrufen
        fetch('https://api.ipify.org?format=json').then(r => r.json()).then(data => userIP = data.ip);

        window.onload = () => { if(currentUser) loginSuccess(); };

        function setAuthMode(mode) {
            authMode = mode;
            document.getElementById('auth-title').innerText = mode === 'register' ? "Account Erstellen" : "Einloggen";
        }

        async function handleAuthAction() {
            const user = document.getElementById('auth-user').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            
            // Check IP Bann
            const banCheck = await db.collection("banned_ips").doc(userIP).get();
            if(banCheck.exists) {
                alert("SYSTEM-FEHLER: Deine IP ist dauerhaft gesperrt.");
                return;
            }

            if(authMode === 'register') {
                const newUser = { name: user, pass: pass, ip: userIP, role: (user === "Zynox" ? "admin" : "agent"), favorites: [] };
                localStorage.setItem(`user_${user}`, JSON.stringify(newUser));
                currentUser = newUser; loginSuccess();
            } else {
                const stored = JSON.parse(localStorage.getItem(`user_${user}`));
                if(stored && stored.pass === pass) { currentUser = stored; loginSuccess(); }
                else alert("Zugriff verweigert!");
            }
        }

        function loginSuccess() {
            localStorage.setItem('logged_in_user', JSON.stringify(currentUser));
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-interface').classList.remove('hidden');
            listenToCloud();
        }

        function listenToCloud() {
            db.collection("global_akten").orderBy("createdAt", "desc").onSnapshot(s => {
                globalAkten = s.docs.map(d => ({ cloudId: d.id, ...d.data() }));
                renderDashboard();
            });
        }

        function renderDashboard() {
            const list = document.getElementById('akte-list');
            list.innerHTML = globalAkten.map(a => `
                <div class="bg-zinc-900 border border-zinc-800 p-6 rounded-2xl relative fade-in">
                    <h4 class="font-black text-xl mb-2 text-white">${a.title}</h4>
                    <p class="text-[9px] text-zinc-600 mb-4">AGENT: ${a.creator}</p>
                    <button onclick="openAkte('${a.cloudId}')" class="w-full bg-blue-600 text-white py-3 rounded-xl text-[10px] font-black uppercase">Öffnen</button>
                    ${(currentUser.name === "Zynox" || a.creator === currentUser.name) ? 
                    `<button onclick="deleteAkte('${a.cloudId}')" class="mt-2 w-full border border-red-500/30 text-red-500 py-2 rounded-xl text-[9px] uppercase font-bold hover:bg-red-500 hover:text-white transition">Löschen</button>` : ''}
                </div>
            `).join('');
        }

        function openAkte(id) {
            const akte = globalAkten.find(a => a.cloudId === id);
            activeAkteId = id; showView('details');
            document.getElementById('details-content').innerHTML = `
                <div class="bg-zinc-900 p-8 rounded-2xl border border-zinc-800">
                    <h2 class="text-3xl font-black text-white mb-4 uppercase italic">${akte.title}</h2>
                    <p class="text-zinc-400 mb-6">${akte.stammdaten}</p>
                    <hr class="border-zinc-800 mb-6">
                    <p class="text-xs text-zinc-500 mb-4">Erstellt von: <b>${akte.creator}</b> (IP: ${akte.creatorIP || 'Unbekannt'})</p>
                    
                    ${currentUser.name === "Zynox" ? `
                        <div class="bg-red-500/10 border border-red-500/50 p-4 rounded-xl">
                            <p class="text-red-500 font-bold text-xs mb-2 uppercase">Admin Tools (Zynox Only)</p>
                            <button onclick="banUser('${akte.creatorIP}', '${akte.creator}')" class="bg-red-600 text-white px-4 py-2 rounded text-[10px] font-black uppercase">User & IP Bannen</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function saveAkte() {
            const title = document.getElementById('akte-title').value;
            const stammdaten = document.getElementById('akte-stammdaten').value;
            const prio = document.getElementById('akte-prio').value;
            db.collection("global_akten").add({
                title, stammdaten, prio, creator: currentUser.name, creatorIP: userIP,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(), entries: []
            }).then(() => showView('dashboard'));
        }

        function deleteAkte(id) {
            if(confirm("Akte unwiderruflich vernichten?")) {
                db.collection("global_akten").doc(id).delete();
            }
        }

        function banUser(ip, name) {
            if(!ip || ip === "undefined") return alert("IP nicht gefunden.");
            if(confirm(`Möchtest du ${name} und die IP ${ip} wirklich bannen?`)) {
                db.collection("banned_ips").doc(ip).set({
                    bannedUser: name,
                    bannedAt: new Date().toISOString(),
                    reason: "Zynox System-Bann"
                }).then(() => {
                    alert("Agent wurde verbannt.");
                    showView('dashboard');
                });
            }
        }

        function showView(v) {
            document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${v}`).classList.remove('hidden');
        }

        function logout() { localStorage.removeItem('logged_in_user'); location.reload(); }
    </script>
</body>
</html>
